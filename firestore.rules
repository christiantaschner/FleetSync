
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin';
    }
    
    function isCompanyMember(companyId) {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }
    
    function hasCompanyRole(companyId, role) {
      return isCompanyMember(companyId) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isCompanyOwner(companyId) {
        return isAuthenticated() && get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
    }
    
    function isAdmin(companyId) {
        return hasCompanyRole(companyId, 'admin');
    }

    // --- Collections Rules ---

    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isAdmin(resource.data.companyId) || isSuperAdmin();
      allow create: if isAuthenticated();
    }
    
    match /companies/{companyId} {
      allow read: if isCompanyMember(companyId) || isSuperAdmin();
      allow update: if isCompanyOwner(companyId) || isAdmin(companyId) || isSuperAdmin();
      allow create: if isAuthenticated(); 
    }

    match /jobs/{jobId} {
      allow read: if isCompanyMember(resource.data.companyId) || isSuperAdmin();
      allow create: if hasCompanyRole(request.resource.data.companyId, 'admin') || hasCompanyRole(request.resource.data.companyId, 'csr') || isSuperAdmin();
      allow update: if isAdmin(resource.data.companyId) || isSuperAdmin() || (isCompanyMember(resource.data.companyId) && request.auth.uid == resource.data.assignedTechnicianId);
      allow delete: if isAdmin(resource.data.companyId) || isSuperAdmin();
    }

    match /technicians/{technicianId} {
      allow read: if isCompanyMember(resource.data.companyId) || isSuperAdmin();
      allow create, update, delete: if isAdmin(resource.data.companyId) || isSuperAdmin();
    }

    match /profileChangeRequests/{requestId} {
        allow read: if isCompanyMember(resource.data.companyId) || isSuperAdmin();
        allow create: if isCompanyMember(request.resource.data.companyId);
        allow update: if isAdmin(resource.data.companyId) || isSuperAdmin();
    }
    
    match /skills/{skillId} {
        allow read: if isCompanyMember(resource.data.companyId) || isSuperAdmin();
        allow create, delete: if isAdmin(resource.data.companyId) || isSuperAdmin();
    }
    
    match /parts/{partId} {
        allow read: if isCompanyMember(resource.data.companyId) || isSuperAdmin();
        allow create, delete: if isAdmin(resource.data.companyId) || isSuperAdmin();
    }

    match /chatMessages/{messageId} {
        allow read: if isCompanyMember(resource.data.companyId) || isSuperAdmin();
        allow create: if isCompanyMember(request.resource.data.companyId);
    }

    match /contracts/{contractId} {
        allow read, create, update, delete: if isAdmin(resource.data.companyId) || isSuperAdmin();
    }
    
    match /equipment/{equipmentId} {
        allow read: if isCompanyMember(resource.data.companyId) || isSuperAdmin();
        allow create: if hasCompanyRole(request.resource.data.companyId, 'admin') || hasCompanyRole(request.resource.data.companyId, 'csr') || isSuperAdmin();
    }
  }
}
