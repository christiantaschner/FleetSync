
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions (Using Custom Claims) ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function getCompanyId() { return request.auth.token.companyId; }
    function getRole() { return request.auth.token.role; }
    function isSuperAdmin() { return getRole() == 'superAdmin'; }
    function isAdmin() { return getRole() == 'admin'; }
    function isCsr() { return getRole() == 'csr'; }
    function isTechnician() { return getRole() == 'technician'; }

    // --- Collection Rules ---

    // USERS
    match /users/{userId} {
      allow get: if isOwner(userId) || (isAdmin() && resource.data.companyId == getCompanyId()) || isSuperAdmin();
      allow list: if (isAdmin() && request.query.where.companyId == getCompanyId()) || isSuperAdmin();
      allow create: if isOwner(userId);
      allow update: if (isAdmin() && resource.data.companyId == getCompanyId()) || isSuperAdmin() ||
                       (isOwner(userId) && request.resource.data.companyId == resource.data.companyId && request.resource.data.role == resource.data.role);
    }

    // COMPANIES
    match /companies/{companyId} {
      allow get: if companyId == getCompanyId() || isSuperAdmin();
      allow update: if (isAdmin() && companyId == getCompanyId()) || isSuperAdmin();
      allow create, delete: if false; // Only backend/admins can create/delete companies
    }

    // JOBS
    match /jobs/{jobId} {
      allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
      allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
      allow create: if (isAdmin() || isCsr()) && request.resource.data.companyId == getCompanyId();
      allow update: if (request.resource.data.companyId == resource.data.companyId) &&
                       ( (isAdmin() || isCsr()) && resource.data.companyId == getCompanyId() ||
                         (isTechnician() && resource.data.assignedTechnicianId == request.auth.uid) );
      allow delete: if isAdmin() && resource.data.companyId == getCompanyId();
    }
    
    // TECHNICIANS
    match /technicians/{docId} {
      allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
      allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
      allow create: if isAdmin() && request.resource.data.companyId == getCompanyId();
      allow update: if isAdmin() && resource.data.companyId == getCompanyId() && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isAdmin() && resource.data.companyId == getCompanyId();
    }

    // SKILLS
    match /skills/{docId} {
      allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
      allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
      allow create: if isAdmin() && request.resource.data.companyId == getCompanyId();
      allow delete: if isAdmin() && resource.data.companyId == getCompanyId();
      allow update: if false; // Skills are just names, no updates needed.
    }
    
    // PARTS
    match /parts/{docId} {
      allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
      allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
      allow create: if isAdmin() && request.resource.data.companyId == getCompanyId();
      allow delete: if isAdmin() && resource.data.companyId == getCompanyId();
      allow update: if false;
    }

    // CONTRACTS
    match /contracts/{docId} {
      allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
      allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
      allow create: if (isAdmin() || isCsr()) && request.resource.data.companyId == getCompanyId();
      allow update: if (isAdmin() || isCsr()) && resource.data.companyId == getCompanyId() && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isAdmin() && resource.data.companyId == getCompanyId();
    }
    
    // EQUIPMENT
    match /equipment/{docId} {
      allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
      allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
      allow create: if (isAdmin() || isCsr()) && request.resource.data.companyId == getCompanyId();
      allow update: if isAdmin() && resource.data.companyId == getCompanyId() && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isAdmin() && resource.data.companyId == getCompanyId();
    }
    
    // PROFILE CHANGE REQUESTS
    match /profileChangeRequests/{docId} {
        allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
        allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
        allow create: if isTechnician() && request.resource.data.technicianId == request.auth.uid;
        allow update: if isAdmin() && resource.data.companyId == getCompanyId() && request.resource.data.companyId == resource.data.companyId;
        allow delete: if isAdmin() && resource.data.companyId == getCompanyId();
    }
    
    // CHAT MESSAGES
    match /chatMessages/{docId} {
        allow get: if resource.data.companyId == getCompanyId() || isSuperAdmin();
        allow list: if request.query.where.companyId == getCompanyId() || isSuperAdmin();
        allow create: if request.resource.data.companyId == getCompanyId(); // anyone in company can create
        allow update, delete: if false; // can't edit chat history
    }
  }
}
