
// This is an autogenerated file from Firebase Studio.
'use server';
/**
 * @fileOverview An AI agent that suggests the most suitable technician for a new job.
 *
 * - allocateJob - A function that suggests the most suitable technician for a new job.
 */

import {ai} from '@/ai/genkit';
import {
  type AllocateJobInput,
  AllocateJobInputSchema,
  type AllocateJobOutput,
  AllocateJobOutputSchema
} from '@/types';

export async function allocateJob(input: AllocateJobInput): Promise<AllocateJobOutput> {
  return allocateJobFlow(input);
}

const prompt = ai.definePrompt({
  name: 'allocateJobPrompt',
  input: {schema: AllocateJobInputSchema},
  output: {schema: AllocateJobOutputSchema},
  prompt: `You are an AI assistant helping dispatchers allocate jobs to field technicians. Your decision must be based on a balance of skill, availability, location, and job priority.

  Follow these rules for availability:
  1. Always prefer an available technician if they are a good fit.
  2. **EXCEPTION FOR EMERGENCIES:** If the new job's priority is 'High', you MAY suggest interrupting a technician who is currently on a 'Low' priority job. You should only do this if it provides a significant advantage (e.g., much closer, has a rare required skill).
  3. You must explicitly state in your reasoning that this is an interruption and why it is justified.
  4. You MUST NOT suggest interrupting a technician who is on a 'Medium' or 'High' priority job.
  5. If you suggest an interruption, the 'suggestedTechnicianId' should be the ID of the technician you are suggesting to interrupt. The UI will handle the fact that they are currently unavailable.
  
  {{#if requiredSkills.length}}
  CRITICAL: The job explicitly requires the following skills: {{#each requiredSkills}}{{{this}}}{{#unless @last}}, {{/unless}}{{/each}}. The chosen technician MUST possess ALL of these skills. This is a non-negotiable constraint.
  {{/if}}

  Given the following job description and a list of technicians, suggest the most suitable technician for the job.
  Consider the job priority when making your suggestion.
  {{#if scheduledTime}}Crucially, the customer has requested a specific appointment time: {{{scheduledTime}}}. The suggested technician must be able to meet this appointment, considering their current location and other commitments. Factor this heavily into your decision.{{/if}}

  When evaluating a technician, consider their 'currentJobs' list to see if they can realistically accommodate this new job alongside their existing commitments.

  Job Description: {{{jobDescription}}}
  Job Priority: {{{jobPriority}}}

  Technician Availability:
  {{#each technicianAvailability}}
  - Technician ID: {{{technicianId}}}, Name: {{{technicianName}}}, Available: {{{isAvailable}}}, Skills: {{#each skills}}{{{this}}}{{#unless @last}}, {{/unless}}{{/each}}, Location: (Latitude: {{{location.latitude}}}, Longitude: {{{location.longitude}}})
    {{#if currentJobs.length}}
    Current Assigned Jobs:
    {{#each currentJobs}}
    - Job ID: {{{jobId}}}, Priority: {{{priority}}}{{#if scheduledTime}}, Scheduled at: {{{scheduledTime}}}{{/if}}
    {{/each}}
    {{/if}}
  {{/each}}

  Suggest the most suitable technician ID and explain your reasoning.
  In your reasoning, refer to technicians by their name (e.g., "Technician Alice Smith is available...") instead of their ID.
  Ensure that the outputted suggestedTechnicianId exists in the technicianAvailability array.
  `,
});

const allocateJobFlow = ai.defineFlow(
  {
    name: 'allocateJobFlow',
    inputSchema: AllocateJobInputSchema,
    outputSchema: AllocateJobOutputSchema,
  },
  async input => {
    const {output} = await prompt(input);
    return output!;
  }
);
